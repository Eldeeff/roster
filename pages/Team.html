<section>
  <div class="mdc-card mdc-theme--primary page-buttons">
    <div class="mdc-card__actions">
      <div class="mdc-card__action-buttons">
        <button class="mdc-button mdc-button--unelevated mdc-card__action-button" id="add-card">
          <i class="material-icons mdc-button__icon">account-plus</i> Add team member
        </button>
        <div class="mdc-menu-anchor sortby">
          <button class="mdc-button mdc-card__action-button">
            <i class="material-icons mdc-button__icon">filter</i> Sort:&nbsp;
            <span>Custom</span>
          </button>
          <div class="mdc-menu" tabindex="-1" data-mdc-auto-init="MDCMenu">
            <ul class="mdc-menu__items mdc-list" role="menu" aria-hidden="true">
              <li class="mdc-list-item" role="menuitem" tabindex="0" aria-disabled="true">
                Sort by:
              </li>
              <li class="mdc-list-item" role="menuitem" tabindex="0" data-sort="name">
                Name
              </li>
              <li class="mdc-list-item" role="menuitem" tabindex="0" data-sort="title">
                Title
              </li>
              <li class="mdc-list-item" role="menuitem" tabindex="0" data-sort="order">
                Custom
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
<section id="team-cards">
</section>
<script>
  $(document).ready(function () {
    function sortTeam(by) {
      r.settings.Team.members.sort(function (a, b) {
        if (typeof a[by] === 'string' && typeof b[by] === 'string') {
          return a[by].localeCompare(b[by]);
        } else if (typeof a[by] === 'number' && typeof b[by] === 'number') {
          return a[by] > b[by];
        }
      });
      $('.mdc-menu-anchor.sortby > button span').text($('.mdc-menu-anchor.sortby .mdc-list-item[data-sort=' + by + ']').text());
      $('#team-cards').html('');
      $(r.settings.Team.members).each(function (i, member) {
        $('#team-cards')
          .append(
            $(r.ui.teamMemberCard(member.id, member.name, member.title, member.bg, member.text)
              .append(r.helper.dialog(`Are you sure you want to remove ${member.name}?`))
            )
          );
      });

      // NEED TO UPDATE HANDLES BETTTERERERERETETEERRRRR
      toggleHandles();
    }

    function toggleHandles() {
      var cond = (r.settings.Team.members.length > 1 && r.settings.Team.settings.sortby == 'order');
      if (cond) {
        $('#team-cards .handle').show();
      } else {
        $('#team-cards .handle').hide();
      }
    }

    // load team
    sortTeam(r.settings.Team.settings.sortby);

    $('.mdc-menu-anchor.sortby > button').on('click', function () {
      var menu = $(this).next('.mdc-menu').get(0).MDCMenu;
      menu.open = !menu.open;
    });
    $('.mdc-menu-anchor.sortby .mdc-list-item[data-sort]').on('click', function () {
      sortTeam($(this).data('sort'));
      r.settings.Team.settings.sortby = $(this).data('sort');
      $('body').trigger('roster:save');
      toggleHandles();
    });

    // add team member
    $('#Team #add-card').on('click', function () {
      var newCard = r.ui.newTeamMemberCard();
      $('#team-cards').append(newCard);
      r.helper.setPalette($(newCard).find('button.colour'));
    });

    $('#team-cards').on('click', '.mdc-card button.save-data', function (e) {
      setTimeout(() => {
        var newMember = $(e.target).parents('.mdc-card');
        var member = r.settings.Team.members[r.settings.Team.members.length - 1];

        var editing = $('#team-cards .mdc-card.editing');
        if (editing.length > 0) {
          member = r.settings.Team.members[r.settings.Team.members.indexOf(r.helper.find(editing.attr('id'), 'id', r.settings.Team.members))];
          editing.remove();
        }

        $(newMember)
          .before(
            $(r.ui.teamMemberCard(member.id, member.name, member.title, member.bg, member.text)
              .append(r.helper.dialog(`Are you sure you want to remove ${member.name}?`))
              .addClass('editing')
            )
          );
        toggleHandles();
      }, 0)
    })

    // edit team member

    $('#team-cards').on('click', '.mdc-card button.edit', function (e) {
      // closeAdding();

      var cardParent = $(e.target).parents('.mdc-card');
      var clickedID = cardParent.attr('id');

      cardParent.addClass('editing')
      $('button', cardParent).prop('disabled', true);
      cardParent.after(r.ui.editTeamMember(clickedID));
    })

    // remove team member
    $('#team-cards').on('click', '.mdc-card button.remove', function (e) {
      // closeAdding();
      var dialog = new mdc.dialog.MDCDialog($('.mdc-dialog', $(e.target).closest('.mdc-card'))[0]);
      dialog.show();
      var memberCard = $(e.target).closest('.mdc-card');
      var index = $('#team-cards .mdc-card').index(memberCard);

      dialog.listen('MDCDialog:accept', function () {
        memberCard.addClass('removing');
        setTimeout(() => {
          memberCard.remove();
          r.helper.remove(index, r.settings.Team.members);
          $('body').trigger('roster:save');
          toggleHandles();
        }, 250)
      });
    })

    $('#team-cards').on('click', '.mdc-card button.colour:not(.mdc-menu-anchor)', function (e) {
      var colourPicker = $(e.target),
        parentCard = colourPicker.parents('.mdc-card');
      if ($('#colour-picker', colourPicker).length < 1) {
        colourPicker.addClass('mdc-menu-anchor');
        colourPicker.append(r.ui.newPalette());
        var menu = new mdc.menu.MDCMenu($('#colour-picker', colourPicker).get(0));
        parentCard.addClass('hasPalette');
        menu.open = true;

        colourPicker.on('click', function (e) {
          menu.open = !menu.open;
          parentCard.addClass('hasPalette');
        });
        menu.listen('MDCMenu:selected', function (e) {
          var palette = {
            colour: $(e.detail.item).css('background-color'),
            text: $(e.detail.item).css('color')
          }
          r.helper.setPalette(colourPicker, palette);
          $('#Team .hasPalette').removeClass('hasPalette');
          $('input', parentCard).trigger('change');
        });
        menu.listen('MDCMenu:cancel', function (e) {
          parentCard.removeClass('hasPalette');
        });
      }
    });

    // handler for click outside adding team member card
    $('body').on('mousedown keydown', function (e) {
      var trigger = false;
      if (e.type === 'keydown') {
        if (e.key === ' ' || e.key === 'Enter' || e.key === 'Escape') {
          trigger = true;
        }
      } else {
        trigger = true;
      }
      if (trigger && $('.team-member.adding.mdc-card').length > 0) {
        if ($('#Team #add-card:disabled').length + $(e.target).closest('.mdc-card.adding').length == 1 || e.key === 'Escape') {
          $('#Team #add-card').prop('disabled', false);
          // close adding card
          var adding = $('.adding.open');
          console.log('yep');
          if (adding.length > 0) {
            adding.removeClass('open');
            setTimeout(function () {
              adding.prev('.mdc-card.editing').find('button').removeProp('disabled');
              adding.prev('.mdc-card.editing').removeClass('editing');
              adding.remove();
            }, 250);
          }
        }
      }
    })

    // sortable 
    Sortable.create($('#team-cards').get(0), {
      animation: 150,
      group: 'team',
      draggable: '.team-member',
      handle: '.handle',
      ghostClass: 'ghost',
      chosenClass: 'chosen',
      dragClass: 'drag',
      onSort: function (e) {
        $('#team-cards .team-member').each(function () {
          index = $(this).index() + 1;
          $(this).attr('data-id', index);
        });
        $('body').trigger('roster:save');
      },
      onStart: function (e) {
        $(e.target).addClass('sorting');
      },
      onEnd: function (e) {
        $(e.target).removeClass('sorting');
      },
    });
  });
</script>