<section>
  <div class="mdc-layout-grid">
    <button class="mdc-button mdc-button--raised mdc-button--primary edit-roster">
      <i class="material-icons">edit</i> Edit Hours</button>
    <button class="mdc-button print-roster">
      <i class="material-icons">print</i> Print</button>
    <!-- <button class="mdc-button email-roster">
      <i class="material-icons">mail</i> Email</button> -->
  </div>
  <div class="mdc-layout-grid header">
    <div class="mdc-layout-grid__inner mdc-grid--no-spacing">
    </div>
  </div>
  <div class="mdc-layout-grid mdc-list roster ready">
  </div>
</section>
<script>
  $(document).ready(function () {

    var papa = $('section#Roster');
    $('.header .mdc-grid', papa).append(r.ui.rosterHeader(r.settings.Company));

    $('.roster', papa).append(r.ui.rosterGrid(r.settings.Team.members));

    setTimeout(function () {
      $('.roster .mdc-cell input.time', papa).each(function () {
        $(this).timepicker({
          appendTo: $(this).parents('.mdc-textfield'),
          minTime: '6:00am',
          maxTime: '8:00pm',
          timeFormat: 'g:i a'
        });
        if ($(this).hasClass('end')) {
          var startTime = $(this).parents('.mdc-textfield').siblings('.mdc-textfield').find('.time.start');
          if (startTime.val() !== '') {
            $(this).timepicker('option', {
              'scrollDefault': (parseInt(startTime.val().split(':')[0]) + parseInt(r.settings.Templates[0].defaultWorkingHours)) +
                startTime.val().split(':')[1],
              'minTime': startTime.val(),
              'showDuration': true
            });
          }
        }
      })

      $('.roster .mdc-cell input.time', papa).on('change', function () {
        if (this.value !== '') {
          $(this).parents('.mdc-textfield').addClass('is-dirty');
        } else {
          $(this).parents('.is-dirty').removeClass('is-dirty');
        }
        if ($(this).hasClass('start')) {
          var endTime = $(this).parents('.mdc-textfield').siblings('.mdc-textfield').find('.time.end');
          if (this.value !== '') {
            endTime.timepicker('option', {
              'scrollDefault': (parseInt(this.value.split(':')[0]) + parseInt(r.settings.Templates[0].defaultWorkingHours)) +
                this.value.split(':')[1],
              'minTime': this.value,
              'showDuration': true
            });
          }
          if (endTime.val() === '' && this.value !== '') {
            endTime.focus();
          }
        }
        updateHours();
      });

      function clearPaste() {
        $('button.paste-time').each(function () {
          if ($('.master-copy-time', papa).length) {
            this.childNodes[0].textContent = 'content_paste';
            this.childNodes[1].textContent = ' Paste';
            if ($(this).parents('.mdc-cell:first').hasClass('master-copy-time') === false) {
              $(this).show();
            } else {
              $(this).hide();
            }
          } else {
            this.childNodes[0].textContent = 'clear';
            this.childNodes[1].textContent = ' Clear';
            $(this).removeAttr('style');
          }
        })
      }

      $(papa).on('click', 'button.copy-time', function () {
        r.helper.setCopyTime(this);
        clearPaste();
      }).on('click', 'button.paste-time', function () {
        var times = r.helper.getCopyTime('.master-copy-time');
        $(this).parents('.mdc-cell:first').find('input.end').val(times[1]).trigger('change');
        $(this).parents('.mdc-cell:first').find('input.start').val(times[0]).trigger('change');
      }).on('click', 'button.done-time', function () {
        $('.master-copy-time', papa).removeClass('master-copy-time');
        clearPaste();
      });


      $('.edit-roster', papa).click(function () {

        function edit(e) {
          e.childNodes[2].textContent = " Save Hours";
          $(e).removeClass('save-data');
          $('.roster', papa).removeClass('ready');
        };

        function save(e) {
          $('.master-copy-time', papa).removeClass('master-copy-time');

          e.childNodes[2].textContent = " Edit Hours";
          $(e).addClass('save-data');
          $('.roster', papa).addClass('ready');
        };
        $(this).text().trim() === 'edit Edit Hours' ? edit(this) : save(this);
        fitTeamImage();
        checkForWeekends();
      });
    }, 0)

    $('.print-roster').click(function () {
      if ($('.roster', papa).hasClass('ready') == false) {
        $('.edit-roster').click();
      }
      setTimeout(function () {
        print();
      }, 10)
    });

    function checkForWeekends() {
      setTimeout(function () {
        if ($('.weekend .is-dirty', papa).length + $('.roster:not(.ready)', papa).length > 0) {
          $('.roster', papa).addClass('weekends');
        } else {
          $('.roster', papa).removeClass('weekends');
        }
      }, 0)
    }

    function updateHours() {
      if (r.settings.Templates[0].hours) {
        setTimeout(function () {
          $('.roster .mdc-cell .is-dirty input.time.end', papa).each(function () {
            $(this).timepicker('option', {
              'showDuration': true
            });
          });

          $('.roster .roster-body', papa).each(function () {
            var hours = 0;
            $('.mdc-cell:not(.team-member)', this).each(function () {
              var start = $('.start', this).timepicker('getTime', new Date()),
                end = $('.end', this).timepicker('getTime', new Date());
              if ($('.start', this).val() != '' && $('.end', this).val() != '') {
                var day = (Date.parse(end) - Date.parse(start)) / 1000 / 60 / 60;
                if (day >= r.settings.Templates[0].defaultWorkingHours && r.settings.Templates[0].break) {
                  day = day - .5;
                }
                hours += day;
              }
            });
            if (hours > 0) {
              $('.team-member .details .hours', this).prop('hidden', false).text(hours + ' hours');
            } else {
              $('.team-member .details .hours', this).prop('hidden', true).text();
            }
          });

        }, 0)
      }
    }

    function fitTeamImage() {
      if (r.settings.Templates[0].avatar) {
        setTimeout(function () {
          $('.roster-body .team-member img').each(function () {
            var thisRatio = $(this).height() / $(this).width(),
              parentRatio = $(this).parents('.avatar').height() / $(this).parents('.avatar').width();
            if (thisRatio <= parentRatio) {
              $(this).addClass('fit-height');
            } else {
              $(this).removeClass('fit-height');
            }
          })
        }, 0)
      }
    }

    $(window).resize(function () {
      fitTeamImage();
    });

    fitTeamImage();
    checkForWeekends();
    updateHours();
  })
</script>