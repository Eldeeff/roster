<section>
  <div class="mdc-card mdc-theme--primary page-buttons">
    <div class="mdc-card__actions">
      <div class="mdc-card__action-buttons">
        <button class="mdc-button mdc-card__action-button mdc-button--unelevated edit-roster">
          <i class="material-icons mdc-button__icon pencil"></i> Edit Hours</button>
        <button class="mdc-button mdc-card__action-button print-roster" type="button">
          <i class="material-icons mdc-button__icon">printer</i> Print</button>
        <!-- <button class="mdc-button email-roster">
      <i class="material-icons">mail</i> Email</button> -->
      </div>
    </div>
  </div>
  <div class="mdc-card header">
    <div class="mdc-card__actions">
    </div>
  </div>
</section>
<section>
  <div class="mdc-layout-grid mdc-list roster ready">
  </div>
</section>
<script>
  $(document).ready(function () {

    var papa = $('section#Roster');
    $('.mdc-card.header .mdc-card__actions', papa).append(r.ui.rosterHeader(r.settings.Company));

    $('.roster', papa).append(r.ui.rosterGrid(r.settings.Team.members));


    function setCopyTime(e) {
      $('.master-copy-time').removeClass('master-copy-time');
      $(e).parents('.mdc-layout-grid__cell:first').addClass('master-copy-time');
    }

    $('body').on('keydown', function (e) {
      if (e.key === 'Escape' && $('.master-copy-time')) {
        $('.master-copy-time button.done-time').click();
      }
    })

    function getCopyTime() {
      var result = [];
      if ($('.master-copy-time')) {
        $('.master-copy-time input.time').each(function () {
          result.push($(this).val());
        });
      } else {
        result = ['', ''];
      }
      return result;
    }

    setTimeout(function () {
      $('.roster .mdc-layout-grid__cell input.time', papa).each(function () {
        $(this).timepicker({
          appendTo: $(this).parents('.mdc-text-field'),
          minTime: '6:00am',
          maxTime: '8:00pm',
          timeFormat: 'g:i a'
        });
        if ($(this).hasClass('end')) {
          var startTime = $(this).parents('.mdc-text-field').siblings('.mdc-text-field').find('.time.start');
          if (startTime.val() !== '') {
            $(this).timepicker('option', {
              'scrollDefault': (parseInt(startTime.val().split(':')[0]) + parseInt(r.settings.Templates[0].defaultWorkingHours)) +
                startTime.val().split(':')[1],
              'minTime': startTime.val(),
              'showDuration': true
            });
          }
        }
      })

      $('.roster .mdc-layout-grid__cell input.time', papa).on('change', function () {
        if (this.value !== '') {
          $(this).parents('.mdc-text-field').addClass('is-dirty');
        } else {
          $(this).parents('.is-dirty').removeClass('is-dirty');
        }
        if ($(this).hasClass('start')) {
          var endTime = $(this).parents('.mdc-text-field').siblings('.mdc-text-field').find('.time.end');
          if (this.value !== '') {
            endTime.timepicker('option', {
              'scrollDefault': (parseInt(this.value.split(':')[0]) + parseInt(r.settings.Templates[0].defaultWorkingHours)) +
                this.value.split(':')[1],
              'minTime': this.value,
              'showDuration': true
            });
          }
          if (endTime.val() === '' && this.value !== '') {
            setTimeout(() => {
              endTime.focus();
            }, 1);
          }
        }
        updateHours();
      });

      function clearPaste() {
        $('button.paste-time').each(function () {
          if ($('.master-copy-time', papa).length) {
            this.childNodes[0].textContent = r.ui.constants.HOURS_PASTE.icon;
            this.childNodes[1].textContent = r.ui.constants.HOURS_PASTE.text;
            if ($(this).parents('.mdc-layout-grid__cell:first').hasClass('master-copy-time') === false) {
              $(this).show();
            } else {
              $(this).hide();
            }
          } else {
            this.childNodes[0].textContent = r.ui.constants.HOURS_CLEAR.icon;
            this.childNodes[1].textContent = r.ui.constants.HOURS_CLEAR.text;
            $(this).removeAttr('style');
          }
        })
      }

      $(papa).on('click', 'button.copy-time', function () {
        setCopyTime(this);
        clearPaste();
      }).on('click', 'button.paste-time', function () {
        var times = getCopyTime();
        $(this).parents('.mdc-layout-grid__cell:first').find('input.end').parent().get(0).MDCTextField.value = times[1];
        $(this).parents('.mdc-layout-grid__cell:first').find('input.start').parent().get(0).MDCTextField.value = times[0];
      }).on('click', 'button.done-time', function () {
        $('.master-copy-time', papa).removeClass('master-copy-time');
        clearPaste();
      });


      $('.edit-roster', papa).click(function () {

        function edit(e) {
          e.childNodes[2].textContent = "Save Hours";
          $(e).removeClass('save-data');
          $('.roster', papa).removeClass('ready');
        };

        function save(e) {
          $('.master-copy-time', papa).removeClass('master-copy-time');

          e.childNodes[2].textContent = "Edit Hours";
          $('.roster', papa).addClass('ready');
          $(e).addClass('save-data');
        };

        $(this).text().trim() === 'Edit Hours' ? edit(this) : save(this);
        checkForWeekends();
      });
    }, 0)

    $('.print-roster').click(function () {
      if ($('.roster', papa).hasClass('ready') == false) {
        $('.edit-roster').click();
      }
      setTimeout(function () {
        print();
      }, 10)
    });

    function checkForWeekends() {
      setTimeout(function () {
        if ($('.weekend .is-dirty', papa).length + $('.roster:not(.ready)', papa).length > 0) {
          $('.roster', papa).addClass('weekends');
        } else {
          $('.roster', papa).removeClass('weekends');
        }
      }, 0)
    }

    function updateHours() {
      setTimeout(function () {
        if (r.settings.Templates[0].hours) {
          $('.roster .mdc-layout-grid__cell .is-dirty input.time.end', papa).each(function () {
            $(this).timepicker('option', {
              'showDuration': true
            });
          });
        }

        $('.roster .roster-body', papa).each(function () {
          var hours = 0;
          $('.mdc-layout-grid__cell:not(.team-member)', this).each(function () {

            $('.ready-time .break', this).remove();

            var start = $('.start', this).timepicker('getTime', new Date()),
              end = $('.end', this).timepicker('getTime', new Date());
            if ($('.start', this).val() != '' && $('.end', this).val() != '') {
              var day = (Date.parse(end) - Date.parse(start)) / 1000 / 60 / 60;
              if (r.settings.Templates[0].break) {
                if (day >= r.settings.Templates[0].defaultWorkingHours) {
                  day = day - .5;
                  $('.ready-time', this).append(`<div class="mdc-chip break mdc-elevation--z1"><i class="material-icons mdc-chip__icon mdc-chip__icon--leading">${r.ui.constants.BREAK_SHORT.icon}</i> &nbsp;&nbsp;&nbsp; <i class="material-icons mdc-chip__icon mdc-chip__icon--leading">${r.ui.constants.BREAK_LONG.icon}</i></div>`);
                } else {
                  $('.ready-time', this).append(`<div class="mdc-chip break mdc-elevation--z1"><i class="material-icons mdc-chip__icon mdc-chip__icon--leading">${r.ui.constants.BREAK_SHORT.icon}</i></div>`);
                }
              }
              hours += day;
            }
          });
          if (hours > 0 && r.settings.Templates[0].hours) {
            $('.team-member .details .hours', this).prop('hidden', false).text(hours + ' hours');
          } else {
            $('.team-member .details .hours', this).prop('hidden', true).text();
          }
        });

      }, 0)
    }


    var header = $('.roster-header'),
      headerTop = header.offset().top;

    $(window).scroll(function () {
      var topBar = $('.mdc-top-app-bar'),
        viewportTop = headerTop - (window.scrollY + topBar.height());
      if (viewportTop < 0) {
        header.addClass('mdc-elevation--z2');
        $('.roster', papa).addClass('scrolling');
      } else {
        header.removeClass('mdc-elevation--z2');
        $('.roster', papa).removeClass('scrolling');
      }

    });

    checkForWeekends();
    updateHours();
  })
</script>